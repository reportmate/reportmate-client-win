# NUPKG Build System Fix Plan

## Issues Identified:

### 1. Payload Structure Problems ✅ FIXED
- [x] chocolateyInstall.ps1 now handles ManagedInstalls directory
- [x] Executable cleanup after installation added
- [x] Removed duplicate template file

### 2. Resource Sharing Issues ❌ NEEDS FIXING

**Current State:**
- MSI properly references `$(var.ResourceDir)\osquery\modules\*.json`
- NUPKG hardcodes payload copying from wrong locations

**Required Changes:**

#### A. Update Build Script Resource Copying (build.ps1)
Around line 562, modify the osquery resource copying:

```powershell
# Copy shared resources from build/resources (single source of truth)
$sharedResourcesDir = "$BuildDir/resources"

# Clean payload directories first
if (Test-Path "$ProgramDataPayloadDir/osquery") {
    Remove-Item "$ProgramDataPayloadDir/osquery" -Recurse -Force
}

# Copy osquery modules from shared resources
if (Test-Path "$sharedResourcesDir/osquery") {
    Copy-Item "$sharedResourcesDir/osquery" $ProgramDataPayloadDir -Recurse -Force
    Write-Success "Copied osquery modules from shared resources"
}

# Copy additional shared resources
$sharedFiles = @(
    "module-schedules.json",
    "install-tasks.ps1", 
    "uninstall-tasks.ps1"
)

foreach ($file in $sharedFiles) {
    $sourcePath = Join-Path $sharedResourcesDir $file
    if (Test-Path $sourcePath) {
        Copy-Item $sourcePath $ProgramFilesPayloadDir -Force
        Write-Verbose "Copied $file from shared resources"
    }
}

# Copy install scripts
$installScriptsDir = "$sharedResourcesDir/install-scripts"
if (Test-Path $installScriptsDir) {
    $installScriptsTarget = "$ProgramFilesPayloadDir/install-scripts"
    Copy-Item $installScriptsDir $ProgramFilesPayloadDir -Recurse -Force
    Write-Verbose "Copied install scripts from shared resources"
}
```

#### B. Update chocolateyInstall.ps1 File List
Update the files to copy to Program Files:

```powershell
$programFilesFiles = @(
    'runner.exe', 
    'version.txt', 
    'module-schedules.json', 
    'install-tasks.ps1', 
    'uninstall-tasks.ps1'
)
```

#### C. Clean Payload After Build
Add cleanup step after NUPKG creation:

```powershell
# Clean up payload after successful build
if (-not $SkipNUPKG -and $nupkgFiles) {
    Write-Verbose "Cleaning up payload runner.exe..."
    $payloadExe = "$ProgramFilesPayloadDir/runner.exe"
    if (Test-Path $payloadExe) {
        Remove-Item $payloadExe -Force -ErrorAction SilentlyContinue
    }
}
```

### 3. MSI Resource Handling ✅ ALREADY CORRECT
The MSI WiX file correctly references:
- `$(var.ResourceDir)\module-schedules.json`
- `$(var.ResourceDir)\osquery\enabled-modules.json`
- `$(var.ResourceDir)\osquery\modules\*.json`
- `$(var.ResourceDir)\install-tasks.ps1`
- `$(var.ResourceDir)\uninstall-tasks.ps1`

### 4. Directory Structure After Fix

```
build/
├── resources/                    # Single source of truth
│   ├── osquery/
│   │   ├── enabled-modules.json
│   │   └── modules/*.json
│   ├── install-scripts/
│   ├── module-schedules.json
│   ├── install-tasks.ps1
│   └── uninstall-tasks.ps1
├── msi/                         # MSI references resources via WiX variables
├── nupkg/
│   ├── payload/                 # Generated from resources during build
│   │   ├── runner.exe          # Copied, then deleted after build
│   │   ├── version.txt
│   │   ├── data/               # -> ProgramData/ManagedReports
│   │   │   ├── osquery/       # From build/resources/osquery
│   │   │   └── appsettings.*
│   │   ├── managedinstalls/    # -> ProgramData/ManagedInstalls  
│   │   │   ├── postinstall.ps1
│   │   │   └── preinstall.ps1
│   │   └── cimian/
│   ├── scripts/                # Source files (copied to payload)
│   └── tools/
│       └── chocolateyInstall.ps1  # Generated by build script
```

## Implementation Priority:

1. ✅ **DONE**: Fix chocolateyInstall.ps1 destinations and cleanup
2. ❌ **TODO**: Update build.ps1 resource copying from shared location
3. ❌ **TODO**: Test both MSI and NUPKG use same osquery modules
4. ❌ **TODO**: Verify postinstall script goes to ManagedInstalls correctly

## Notes:
- MSI and NUPKG should both source from `build/resources` for consistency
- Executable should be removed from payload after successful NUPKG build
- postinstall.ps1 belongs in `C:\ProgramData\ManagedInstalls`, not embedded in chocolateyInstall.ps1
